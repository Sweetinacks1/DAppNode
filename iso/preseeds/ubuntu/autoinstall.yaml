#cloud-config
autoinstall:
  version: 1
  interactive-sections:
    - identity
    - keyboard
    - locale
    - network
    - storage
    - timezone

  ssh:
    install-server: true

  packages:
#    - chrony
    - openssh-server
    - vim
    - sudo
#    - iw # TODO: FIX
#    - iwd
    - wpasupplicant
    - intel-microcode
#    - build-essential # TODO: FIX
    - linux-generic
#    - firmware-iwlwifi
#    - avahi-utils # TODO: Fix
#    - iptables # TODO: Try
  apt:
    fallback: continue-anyway

  late-commands:
    - "mkdir -p /target/usr/src/dappnode"
    - "cp -ar /cdrom/dappnode/* /target/usr/src/dappnode/"
    - "cp -a /cdrom/dappnode/scripts/rc.local /target/etc/rc.local"
    - "chmod +x /target/usr/src/dappnode/scripts/dappnode_install_pre.sh"
    - "chmod +x /target/usr/src/dappnode/scripts/static_ip.sh"
    - "sh -c 'gpasswd -a $(getent passwd 1000 | cut -d: -f1) sudo' "
#    - "/target/usr/src/dappnode/scripts/static_ip.sh"
    - "/target/usr/src/dappnode/scripts/dappnode_install_pre.sh UPDATE"
